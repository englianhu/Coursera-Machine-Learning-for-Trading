---
title: "<img src='figure/coursera.jpg' width='37'> <img src='figure/ucsc.png' width='240'>"
subtitle: "<span style='color:white; background-color:#4E79A7;'>Bayesian Statistics: Mixture Models</span> (Assessment Week 5 with Codes)"
author: "[¬ÆŒ≥œÉ, Lian Hu](https://englianhu.github.io/) <img src='figure/quantitative trader 1.jpg' width='12'> <img src='figure/ENG.jpg' width='24'> ¬Æ"
date: "`r lubridate::today('Asia/Tokyo')`"
output:
  html_document: 
    mathjax: https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    code_folding: hide
    css: CSSBackgrounds.css
---

<br>
<span style='color:green'>**Theme Song**</span>
<br>

<audio src="music/California-Dreaming-Chorus.mp3" controls></audio>
<br>

------

# Setting

## SCSS Setup

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
.table-hover > tbody > tr:hover { 
  background-color: #8D918D;
}
</style>

```{r class.source='bg-success', class.output='bg-primary', message = FALSE, warning = FALSE}
# install.packages("remotes")
library('BBmisc', 'rmsfuns')
#remotes::install_github("rstudio/sass")
lib('sass')
```

```{scss class.source='bg-success', class.output='bg-primary'}
/* https://stackoverflow.com/a/66029010/3806250 */
h1 { color: #002C54; }
h2 { color: #2F496E; }
h3 { color: #375E97; }
h4 { color: #556DAC; }
h5 { color: #92AAC7; }

/* ----------------------------------------------------------------- */
/* https://gist.github.com/himynameisdave/c7a7ed14500d29e58149#file-broken-gradient-animation-less */
.hover01 {
  /* color: #FFD64D; */
  background: linear-gradient(155deg, #EDAE01 0%, #FFEB94 100%);
  transition: all 0.45s;
  &:hover{
    background: linear-gradient(155deg, #EDAE01 20%, #FFEB94 80%);
    }
  }

.hover02 {
  color: #FFD64D;
  background: linear-gradient(155deg, #002C54 0%, #4CB5F5 100%);
  transition: all 0.45s;
  &:hover{
    background: linear-gradient(155deg, #002C54 20%, #4CB5F5 80%);
    }
  }

.hover03 {
  color: #FFD64D;
  background: linear-gradient(155deg, #A10115 0%, #FF3C5C 100%);
  transition: all 0.45s;
  &:hover{
    background: linear-gradient(155deg, #A10115 20%, #FF3C5C 80%);
    }
  }
```

```{r global_options, class.source='hover01', class.output='hover02'}
## https://stackoverflow.com/a/36846793/3806250
options(width = 999)
knitr::opts_chunk$set(class.source = 'hover01', class.output = 'hover02', class.error = 'hover03')
```

<br><br>

## Setup

```{r warning=FALSE, message=FALSE}
if(!suppressPackageStartupMessages(require('BBmisc'))) {
  install.packages('BBmisc', dependencies = TRUE, INSTALL_opts = '--no-lock')
}
suppressPackageStartupMessages(require('BBmisc'))
# suppressPackageStartupMessages(require('rmsfuns'))

pkgs <- c('devtools', 'knitr', 'kableExtra', 'tidyr', 
          'readr', 'lubridate', 'reprex', 'magrittr', 
          'timetk', 'plyr', 'dplyr', 'stringr', 
          'tdplyr', 'tidyverse', 'formattable', 
          'echarts4r', 'paletteer')

suppressAll(lib(pkgs))
# load_pkg(pkgs)

## Set the timezone but not change the datetime
Sys.setenv(TZ = 'Asia/Tokyo')
## options(knitr.table.format = 'html') will set all kableExtra tables to be 'html', otherwise need to set the parameter on every single table.
options(warn = -1, knitr.table.format = 'html')#, digits.secs = 6)

## https://stackoverflow.com/questions/39417003/long-vectors-not-supported-yet-abnor-in-rmd-but-not-in-r-script
knitr::opts_chunk$set(message = FALSE, warning = FALSE)#, 
                      #cache = TRUE, cache.lazy = FALSE)

rm(pkgs)
```

<br><br>

# Tutorial

## Wk 1

### Wk 1.1 : Introduction to Quantitative Trading and TensorFlow

#### Wk 1.1.1 : Introduction to TensorFlow, Trading, ML

##### Wk 1.1.1.2 : Welcome to Using Machine Learning in Trading and Finance

> **Welcome to Using Machine Learning in Trading and Finance**
We designed this course for finance, investment management and trading professionals. Machine learning and data science professionals who are interested in applying their skills to developing trading strategies can also benefit from this course. For those of you who are new to trading and investing,  we give a brief introduction to these areas at the beginning of Course 1 : Introduction to Trading, Machine Learning and GCP. It would be helpful to have a basic understanding of financial markets (equities, bonds, derivatives, market structure, and hedging. 
>
If you feel you need a more comprehensive introduction to financial markets, Coursera offers "The Role of Global Financial Markets" at <https://www.coursera.org/learn/capital-markets>. The first two weeks (6 hours) of this four-week course should be sufficient.
>
To be successful in this course, you should have a basic competency in Python programming and familiarity with pertinent libraries for machine learning, such as Scikit-Learn, StatsModels, and Pandas. If you passed the Python pretest then you should not have any difficulties completing the Jupyter notebooks and QwikLabs that are used throughout the courses. Experience with SQL will be helpful, but is not required. You should have a background in statistics (expected values and standard deviation, Gaussian distributions, higher moments, probability, linear regressions).
>
At the end of the course you will be able to do the following: 
>
- Design basic quantitative trading strategies 
- Identify key metrics used to measure trading strategy performance
- Use Keras and TensorFlow to build machine learning models
- Build a pair trading strategy prediction model and back test it
- Build a momentum-based trading model and back test it
- Finally, please feel free to post any questions or comments in the [discussion forums](https://www.coursera.org/learn/introduction-trading-machine-learning-gcp/discussions).

#### Wk 1.1.2 : Understand Quantitative Trading Strategies

##### Wk 1.1.2.1 : ÂãïÁîª„ÉÜ„Çπ„Éà - Basic Trading Strategy Entries and Exits Endogenous Exogenous

Ë≥™Âïè 1 : If you are long an asset (or instrument), what are some examples of pre-planned risk management?

<span style='color:green'>‚úîÔ∏è A sell order above the current market price</span>

> **Ê≠£Ëß£**
This would automatically take a profit on your holding if the market trades higher and would also reduce (or eliminate) your long exposure which would reduce your risk. This is a trade "exit" which we will talk about later.

- A buy order above the current market price

> **„Åì„Çå„ÇíÈÅ∏Êäû„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ**
This would add to your long position and increase your risk exposure. This is not risk management but could be part of a momentum strategy which we will talk about in later session.

<span style='color:green'>‚úîÔ∏è A sell order below the current market price</span>

> **Ê≠£Ëß£**
This is a stop-loss order that would limit your losses on your long position in the market trades lower. We will talk about different types of stop losses later.

- A buy order below the current market price

> **„Åì„Çå„ÇíÈÅ∏Êäû„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ**
This would increase your risk exposure when you are already taking a loss on your current long position. this is an example of a trade "entry" which we will talk about later.

2. Which of the following are examples of a combination of endogenous and exogenous trading rules

- Sell Microsoft if the closing price is below the daily average and the volume traded is higher than the previous day's volume

> **„Åì„Çå„ÇíÈÅ∏Êäû„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ**
This is a combination of two endogenous rules as both are based on Microsoft's price and volume traded.

<span style='color:green'>‚úîÔ∏è Sell Microsoft if the closing price is below the daily average and the closing price of SPY (S&P 500 ETF) is also below its daily average.</span>

> **Ê≠£Ëß£**
This is a combination of and endogenous rule based on Microsoft's closing price and an exogenous rule based on SPY's closing price.

<span style='color:green'>‚úîÔ∏è Sell Microsoft if trading volume is lower than the previous day and the unemployment rate increased during the previous month.</span>

> **Ê≠£Ëß£**
This is a combination of and endogenous rule based on Microsoft's trading volume and an exogenous rule based on the level of a macroeconomic variable.

- Buy Apple if reported quarterly profits are up and Microsoft's reported quarterly sales are down.

> **„Åì„Çå„ÇíÈÅ∏Êäû„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ**
This is a combination of two exogenous rules, one based on Apple's fundamental data and one based on Microsoft's fundamental data.

##### Wk 1.1.2.2 : ÂãïÁîª„ÉÜ„Çπ„Éà - Basic Trading Strategy Building a Trading Model

Ë≥™Âïè 1 : You have sold short Amazon at 1,800 and have a 50 basis point profit objective, Which order should you place for your profit exit?

- Buy Amazon at 1,890
- Sell Amazon at 1,890
- Buy Amazon at 1,710
<span style='color:green'>‚úîÔ∏è Sell Amazon at 1,710</span>

> **Ê≠£Ëß£**
This would be a profit exit as you have sold Amazon short at 1,800 and bought it back at 1,710 for a profit of 90 or 0.5%

##### Wk 1.1.2.3 : ÂãïÁîª„ÉÜ„Çπ„Éà - Advanced Concepts in Trading Strategies

Ë≥™Âïè 1 : If you sell MSFT at 150  and have a profit objective of 500 basis points and a loss tolerance of 200 basis points what exit orders should you place?

- Buy MSFT at 147 and buy MSFT at 157.5
- Sell MSFT at 147 and sell MSFT at 157.5
- Buy MSFT at 142.5 and buy MSFT at 153
<span style='color:green'>‚úîÔ∏è Buy MSFT at 147 and buy MSFT at 153</span>

> **Ê≠£Ëß£**
This would be a profit objective 500 basis points (as selling MSFT at 150 and buying it back at 142.5 would give you a profit of 7.5 or 5%) and a loss tolerance of 200 basis points (as selling MSFT at 150 and buying it back at 153 would give you a loss of 3 or 2%.

Ë≥™Âïè 2 : You are trading Alphabet (GOOG) and have entered with a buy of 1000 shares at $1100. You have a profit target of 400 basis points and a dynamic stop-loss initially set at 200 basis points below your entry point. During the next week the trading range for GOOG is 1080 to 1130.  At the end of the week the price of GOOG is 1110 and your trade is still open. What exit orders do you currently have in the market?

- Stop-loss order to sell GOOG at 1078 and a limit order to sell GOOG at 1144.

- Stop-loss order to sell GOOG at 1107.40 and a limit order to sell GOOG at 1175.2.

- Stop-loss order to sell GOOG at 1107.40 and a limit order to sell GOOG at 1144.

<span style='color:green'>‚úîÔ∏è Stop-loss order to sell GOOG at 1100 and a limit order to sell GOOG at 1144</span>

> **Ê≠£Ëß£**
Yes. You correctly adjusted your dynamic stop-loss order so that it is 200 basis points below the maximum price of GOOG during the week, and you kept your profit exit order at its original level of 4% above your entry point of 1100.

Ë≥™Âïè 3 : You are trading Microsoft (MSFT) and have shorted 1,000 shares at $160. You have a profit target of 500 basis points and a variable dynamic stop-loss initially set at 300 basis points above your entry point.

Your risk management strategy is to reduce the size of your stop-loss margin by 50% of your unrealized profit ( on your MSFT short position and to have the stop-loss level adjust to the current MSFT price if your trade has an unrealized profit. If your trade has an unrealized loss the stop-loss level stays at the original level

During the next 5 days the trading range for MSFT is 154 to 164. At the end of the week the price of MSFT is 154 and your trade is still open. What exit orders do you currently have in the market?

- Stop-loss order to buy MSFT at 161.62 and a limit order to buy back MSFT at 152.

- Stop-loss order to buy MSFT at 158.62 and a limit order to buy back MSFT at 152.

- Stop-loss order to buy MSFT at 164.80 and a limit order to buy back MSFT at 152.

<span style='color:green'>‚úîÔ∏è Stop-loss order to buy MSFT at 155.62 and a limit order to buy back MSFT at 152.</span>

> **Ê≠£Ëß£**
Yes, these would the exit orders based on a variable dynamic stop loss where the stop-loss level trails the lowest price achieved by MSFT during the period and the stop-loss margin is reduced by 50% of the unrealized profit. The stop-loss level for a dynamic stop loss would be 154 * 1.03 = 158.62.  As you are using a variable dynamic stop loss, and your short position has an unrealized profit of 160 - 154 = \$6, you need to reduce the stop-loss margin by 50% of this amount or \$3. Your stop loss should be set at 158.62 - 3 = 155.62.

##### Wk 1.1.2.4 : „ÉÜ„Çπ„Éà - Understand Quantitative Strategies

**Understand Quantitative Strategies (ÂêàË®àÁÇπÊï∞ 4)**

Ë≥™Âïè 1 : If you believe that the price and volume history of an asset are all that is needed to design a trading strategy then you would would use an endogenous trading rule. What is the theoretical justification for using this type of strategy? (1ÁÇπ)

- Markets are efficient and fully incorporate all available information (both public and private).

- Asset prices follow a random walk with equal probabilities of increasing and decreasing

<span style='color:green'>‚úîÔ∏è Asset and market prices tend to have momentum so that stocks whose prices are in an up trends tend to increase in value and those in a downtrend tend to decrease in value.</span>

> Ê≠£Ëß£
Yes, if you believe that asset prices have momentum then price and volume data is all you need to make predictions of future prices.

<span style='color:green'>‚úîÔ∏è Fundamental data such as historic earning and sales growth are already fully reflected in the current market price and so have no predictive power.</span>

> Ê≠£Ëß£
Yes, if you instead believed that fundamental data have predictive value, then you should incorporate them into an exogenous trading rule.


Ë≥™Âïè 2 : The basic trading model parameters are entry signal, profit exit, stop-loss and time-out. How can you use these parameters and machine learning to optimize your trading strategy? (1ÁÇπ)

- Vary the the type of entry signal and profit exit levels in backtesting with the objective of maximizing profit.

<span style='color:green'>‚úîÔ∏è Vary the the type of entry signal, profit exit levels,  stop loss levels and trade completion time limits in backtesting with the objective of maximizing risk adjusted return (Sharpe ratio) within your tolerance for PnL volatility and maximum drawdown.</span>

> Ê≠£Ëß£
Yes, Sharpe ratio maximization leads to an optimal trading strategy as long as it is constrained by time limits, PnL volatility limits and maximum drawdown tolerance. This will give you a strategy with stop-loss levels that can be tolerated when you implement it in  live trading.

- Vary the the type of entry signal and profit exit levels in backtesting with the objective of maximizing risk adjusted return (Sharpe ratio).


Ë≥™Âïè 3 : The main benefit of a dynamic stop loss over a static stop loss is that: (1ÁÇπ)

<span style='color:green'>‚úîÔ∏è Dynamic stop losses reduce the expected risk of your strategy.</span>

> Ê≠£Ëß£
Yes. Dynamic stop losses, which maintain a fixed margin between the stop-loss level and the most favorable market price achieved, can reduce the maximum loss in a strategy (at worst the maximum loss is unaffected). This reduces the expected risk in the strategy but also make it more likely that you will be stopped out rather than profited out. This can have a negative impact on your expected return from a strategy.

- Dynamic stop losses increase your expected returns from a trading strategy.

- Dynamic stop losses guarantee that your strategy will not make a loss even if it is stopped out.

Ë≥™Âïè 4 : Endogenous trading rules are often created by: (1ÁÇπ)

<span style='color:green'>‚úîÔ∏è Technical analysts</span>

> Ê≠£Ëß£
Yes, Technical analysts or chartists believe that all of the information necessary to create a trading rule or strategy is contained in the price and volume history of an asset. 

- Statistical arbitrage traders
- Strategists
- Quantitative trading groups

### Wk 1.2 : Introduction to TensorFlow

#### Wk 1.2.1 : Introduction to TensorFlow

##### Wk 1.2.1.7 : Lab: Writing low-level TensorFlow Programs

**Lab: Writing low-level TensorFlow Programs**

In this lab, you will create a machine learning model using the TensorFlow Estimator class and evaluate its performance.

**Tips for Course Labs**
Get the most out of Coursera and Qwiklabs by trying our tips below.

**Avoid account confusion with private browsing**
**Close this page and log back in to Coursera in Incognito mode** before moving on. When you return to this course and lab instructions page, click Open Tool to continue.

By using incognito mode, this ensures that you don't accidentally use your own Google account (including Gmail) while accessing the Google Cloud Console. This also prevents Qwiklabs from logging you out of your own Google accounts.

Detailed instructions for using Incognito mode in Google Chrome are [available here](https://support.google.com/chrome/answer/95464?co=GENIE.Platform%3DDesktop&hl=en). Depending on your browser, Incognito mode might also be called Private Browsing or InPrivate Browsing.

To ensure lab completion is marked in Coursera:

1. Access each individual lab by clicking **Open Tool** in Coursera:

2. Complete the lab in Qwiklabs.

3. Click **End Lab** in Qwiklabs (click this only after you are ready to end the lab)

4. Close the Qwiklabs browser window or tab.

If you experience any issues and need support, [submit a request](https://goo.gl/LdYwdN) here.

By opening the tool, you are agreeing to Qwiklabs' [Terms of Service)[https://qwiklabs.com/terms_of_service].

##### Wk 1.2.1.13 : Lab: Manipulating data with TensorFlow Dataset API

**Lab: Manipulating data with TensorFlow Dataset API**

In this lab, you will create a machine learning model using the TensorFlow Estimator class and evaluate its performance.

Tips for Course Labs
Get the most out of Coursera and Qwiklabs by trying our tips below.

Avoid account confusion with private browsing
Close this page and log back in to Coursera in Incognito mode before moving on. When you return to this course and lab instructions page, click Open Tool to continue.

By using incognito mode, this ensures that you don't accidentally use your own Google account (including Gmail) while accessing the Google Cloud Console. This also prevents Qwiklabs from logging you out of your own Google accounts.

Detailed instructions for using Incognito mode in Google Chrome are [available here](https://support.google.com/chrome/answer/95464?co=GENIE.Platform%3DDesktop&hl=en). Depending on your browser, Incognito mode might also be called Private Browsing or InPrivate Browsing.

To ensure lab completion is marked in Coursera:

1. Access each individual lab by clicking **Open Tool** in Coursera:

2. Complete the lab in Qwiklabs.

3. Click **End Lab** in Qwiklabs (click this only after you are ready to end the lab)

4. Close the Qwiklabs browser window or tab.

If you experience any issues and need support, [submit a request](https://goo.gl/LdYwdN) here.

By opening the tool, you are agreeing to Qwiklabs' [Terms of Service](https://qwiklabs.com/terms_of_service).

<br>

## Wk 2

### Wk 2.1 : Training neural networks with Tensorflow 2 and Keras

#### Wk 2.1.1 : Overview of Neural Networks and Introduction to Keras APIs

##### Wk 2.1.1.7 : Lab: Introducing the Keras Sequential API

**Lab: Introducing the Keras Sequential API**

In this lab, you will create a machine learning model using the TensorFlow Estimator class and evaluate its performance.

**Tips for Course Labs**
Get the most out of Coursera and Qwiklabs by trying our tips below.

**Avoid account confusion with private browsing**
**Close this page and log back in to Coursera in Incognito mode** before moving on. When you return to this course and lab instructions page, click Open Tool to continue.

By using incognito mode, this ensures that you don't accidentally use your own Google account (including Gmail) while accessing the Google Cloud Console. This also prevents Qwiklabs from logging you out of your own Google accounts.

Detailed instructions for using Incognito mode in Google Chrome are [available here](https://support.google.com/chrome/answer/95464?co=GENIE.Platform%3DDesktop&hl=en). Depending on your browser, Incognito mode might also be called Private Browsing or InPrivate Browsing.

To ensure lab completion is marked in Coursera:

1. Access each individual lab by clicking **Open Tool** in Coursera:

2. Complete the lab in Qwiklabs.

3. Click **End Lab** in Qwiklabs (click this only after you are ready to end the lab)

4. Close the Qwiklabs browser window or tab.

If you experience any issues and need support, [submit a request](https://goo.gl/LdYwdN) here.

By opening the tool, you are agreeing to Qwiklabs' [Terms of Service](https://qwiklabs.com/terms_of_service).

##### Wk 2.1.1.13 : Lab: Introducing the Keras Functional API

**Lab: Introducing the Keras Functional API**

In this lab, you will create a machine learning model using the TensorFlow Estimator class and evaluate its performance.

**Tips for Course Labs**
Get the most out of Coursera and Qwiklabs by trying our tips below.

**Avoid account confusion with private browsing**
**Close this page and log back in to Coursera in Incognito mode** before moving on. When you return to this course and lab instructions page, click Open Tool to continue.

By using incognito mode, this ensures that you don't accidentally use your own Google account (including Gmail) while accessing the Google Cloud Console. This also prevents Qwiklabs from logging you out of your own Google accounts.

Detailed instructions for using Incognito mode in Google Chrome are [available here](https://support.google.com/chrome/answer/95464?co=GENIE.Platform%3DDesktop&hl=en). Depending on your browser, Incognito mode might also be called Private Browsing or InPrivate Browsing.

To ensure lab completion is marked in Coursera:

1. Access each individual lab by clicking **Open Tool** in Coursera:

2. Complete the lab in Qwiklabs.

3. Click **End Lab** in Qwiklabs (click this only after you are ready to end the lab)

4. Close the Qwiklabs browser window or tab.

If you experience any issues and need support, [submit a request](https://goo.gl/LdYwdN) here.

By opening the tool, you are agreeing to Qwiklabs' [Terms of Service](https://qwiklabs.com/terms_of_service).

<br>

## Wk 3

### Wk 3.1 : Build a Momentum-based Trading System



<br><br>

# Appendix

## Blooper

## Documenting File Creation 

It's useful to record some information about how your file was created.

- File creation date: 2021-05-28
- File latest updated date: `r today('Asia/Tokyo')`
- `r R.version.string`
- [**rmarkdown** package](https://github.com/rstudio/rmarkdown) version: `r packageVersion('rmarkdown')`
- File version: 1.0.0
- Author Profile: [¬ÆŒ≥œÉ, Eng Lian Hu](https://github.com/scibrokes/owner)
- GitHub: [Source Code](https://github.com/englianhu/coursera-bayesian-statistics-mixture-models)
- Additional session information:

```{r info, warning=FALSE, error=TRUE, results='asis'}
suppressMessages(require('dplyr', quietly = TRUE))
suppressMessages(require('magrittr', quietly = TRUE))
suppressMessages(require('formattable', quietly = TRUE))
suppressMessages(require('knitr', quietly = TRUE))
suppressMessages(require('kableExtra', quietly = TRUE))

sys1 <- devtools::session_info()$platform %>% 
  unlist %>% data.frame(Category = names(.), session_info = .)
rownames(sys1) <- NULL

sys2 <- data.frame(Sys.info()) %>% 
  dplyr::mutate(Category = rownames(.)) %>% .[2:1]
names(sys2)[2] <- c('Sys.info')
rownames(sys2) <- NULL

if (nrow(sys1) == 9 & nrow(sys2) == 8) {
  sys2 %<>% rbind(., data.frame(
  Category = 'Current time', 
  Sys.info = paste(as.character(lubridate::now('Asia/Tokyo')), 'JSTüóæ')))
} else {
  sys1 %<>% rbind(., data.frame(
  Category = 'Current time', 
  session_info = paste(as.character(lubridate::now('Asia/Tokyo')), 'JSTüóæ')))
}

sys <- cbind(sys1, sys2) %>% 
  kbl(caption = 'Additional session information:') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  row_spec(0, background = 'DimGrey', color = 'yellow') %>% 
  column_spec(1, background = 'CornflowerBlue', color = 'red') %>% 
  column_spec(2, background = 'grey', color = 'black') %>% 
  column_spec(3, background = 'CornflowerBlue', color = 'blue') %>% 
  column_spec(4, background = 'grey', color = 'white') %>% 
  row_spec(9, bold = T, color = 'yellow', background = '#D7261E')

rm(sys1, sys2)
sys
```

## Reference

<br><br>
